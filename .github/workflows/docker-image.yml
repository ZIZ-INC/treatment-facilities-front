name: Next.js CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: self-hosted
    outputs:
      build_start_time: ${{ steps.record_build_start_time.outputs.build_start_time }}

    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: –í–∫–ª—é—á–µ–Ω–∏–µ Yarn —á–µ—Ä–µ–∑ Corepack
        run: corepack enable yarn

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: yarn install --frozen-lockfile

      - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
        run: yarn test

      - name: –ó–∞–ø–∏—Å—å –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ —Å–±–æ—Ä–∫–∏
        id: record_build_start_time
        run: echo "build_start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        run: |
          echo "GITHUB_COMMIT_MESSAGE=${{ github.event.head_commit.message }}" >> $GITHUB_ENV
          echo "GITHUB_ACTOR=${{ github.actor }}" >> $GITHUB_ENV
          echo "–ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}"
          echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${{ github.actor }}"


      - name: –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ Telegram ‚Äî —Å—Ç–∞—Ä—Ç —Å–±–æ—Ä–∫–∏
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=Markdown" \
            --data-urlencode "text=\`\`\`
            üöÄ –°–±–æ—Ä–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $GITHUB_ACTOR
            –ü—Ä–æ–µ–∫—Ç: ${{ secrets.PROJECT_NAME }}
            –°—Å—ã–ª–∫–∞: ${{ secrets.PROJECT_LINK }}
            –ö–æ–º–º–∏—Ç: $GITHUB_COMMIT_MESSAGE
            \`\`\`"

  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ GitHub Secrets
        run: |
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" > .env.production
          echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env.production
          echo "API_URL=${{ secrets.API_URL }}" >> .env.production
          echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> .env.production
          echo "NEXT_PUBLIC_VAPID_PUBLIC_KEY=${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}" >> .env.production
          echo "NEXT_PUBLIC_COMPANY_ID=${{ secrets.NEXT_PUBLIC_COMPANY_ID }}" >> .env.production
          echo "NEXT_PUBLIC_CHAT_REST_URL=${{ secrets.NEXT_PUBLIC_CHAT_REST_URL }}" >> .env.production
          echo "NEXT_PUBLIC_CHAT_WEBSOCKET_URL=${{ secrets.NEXT_PUBLIC_CHAT_WEBSOCKET_URL }}" >> .env.production
          echo "NEXT_PUBLIC_OPENAI_API_KEY=${{ secrets.NEXT_PUBLIC_OPENAI_API_KEY }}" >> .env.production

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ Docker (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
        run: |
          docker network inspect nextjs_network >/dev/null 2>&1 || docker network create nextjs_network

      - name: –°–±–æ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ Docker-–æ–±—Ä–∞–∑–∞
        run: docker compose -f docker/production/compose.yaml build --no-cache

      - name: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        run: |
          if docker ps -q --filter "name=app-mamanfest-frontend" | grep -q .; then
            echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            docker stop app-mamanfest-frontend || true
            docker rm app-mamanfest-frontend || true
          else
            echo "–°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω."
          fi

      - name: –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: docker compose -f docker/production/compose.yaml up -d --no-deps

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          for i in {1..10}; do
            if curl -f http://127.0.0.1:3001; then
              echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
              break
            fi
            echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            sleep 5
          done

      - name: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏ –∏ –¥–µ–ø–ª–æ—è
        if: always()
        id: compute_time
        run: |
          END_TIME=$(date +%s)
          START_TIME=${{ needs.build.outputs.build_start_time }}
          DURATION=$(( END_TIME - START_TIME ))
          echo "build_time=$DURATION" >> $GITHUB_OUTPUT

      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç-—Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        run: |
          echo "GITHUB_COMMIT_MESSAGE=${{ github.event.head_commit.message }}" >> $GITHUB_ENV
          echo "GITHUB_ACTOR=${{ github.actor }}" >> $GITHUB_ENV
          echo "–ö–æ–º–º–∏—Ç: ${{ github.event.head_commit.message }}"
          echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${{ github.actor }}"

      - name: –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ Telegram ‚Äî —É—Å–ø–µ—à–Ω—ã–π –¥–µ–ø–ª–æ–π
        if: success()
        run: |
          build_time=${{ steps.compute_time.outputs.build_time }}
          source $GITHUB_ENV
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=Markdown" \
            --data-urlencode "text=\`\`\`
            ‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω—ã–π
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $GITHUB_ACTOR
            –ü—Ä–æ–µ–∫—Ç: ${{ secrets.PROJECT_NAME }}
            –ö–æ–º–º–∏—Ç: $GITHUB_COMMIT_MESSAGE
            –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏+–¥–µ–ø–ª–æ—è: ${build_time} c
            \`\`\`"

      - name: –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ Telegram ‚Äî –æ—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è
        if: failure()
        run: |
          build_time=${{ steps.compute_time.outputs.build_time }}
          source $GITHUB_ENV
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=Markdown" \
            --data-urlencode "text=\`\`\`
            ‚ùå –î–µ–ø–ª–æ–π –Ω–µ —É–¥–∞–ª—Å—è
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $GITHUB_ACTOR
            –ü—Ä–æ–µ–∫—Ç: ${{ secrets.PROJECT_NAME }}
            –ö–æ–º–º–∏—Ç: $GITHUB_COMMIT_MESSAGE
            –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏+–¥–µ–ø–ª–æ—è: ${build_time} c
            \`\`\`"

  cleanup:
    runs-on: self-hosted
    if: always()
    needs: [build, deploy]
    steps:
      - name: –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã Docker
        run: |
          docker image prune -af
          docker container prune -f
          docker network prune -f
          docker builder prune -af
